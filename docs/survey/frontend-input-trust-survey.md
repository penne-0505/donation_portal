---
title: "Frontend Input Trust Survey"
domain: "security"
status: "active"
version: 1
created: "2025-11-04"
updated: "2025-11-04"
related_issues: []
related_prs: []
references: []
---

# フロントエンドからの入力信頼性に関する調査レポート

## 背景

本プロジェクトにおいて、セキュリティ強化の一環として、フロントエンドからの入力やデータを全面的に信頼せず、サーバーサイドで適切に処理されているかを確認する必要がある。特に決済機能など、金銭が関わる処理については、不正な操作を防ぐための厳格な検証が求められる。

## 目的

本調査の目的は、プロジェクト全体のアーキテクチャ、特に決済処理におけるサーバーサイドの検証ロジックを分析し、フロントエンドからの入力値を信頼しない設計（Untrusted Client）が徹底されているかを確認することである。

## 手法

以下の手順で調査を実施した。

1.  **関連ドキュメントの確認**: `docs/standards/` 配下のガイドラインを確認し、調査書のフォーマットと要件を把握した。
2.  **ソースコードの静的解析**:
    *   プロジェクト全体のディレクトリ構造を把握し、特に入力処理、ビジネスロジック、外部API連携に関連するコンポーネントを特定した。
    *   `functions/` ディレクトリ内のサーバーレス関数、特に決済処理を担当する `functions/api/checkout/session.ts` を中心に読み解いた。
    *   `src/lib/` 配下のコアライブラリ、中でも `src/lib/payments/stripeClient.ts` がStripe APIとどのように連携しているかを確認した。
    *   フロントエンドからのリクエストボディが、サーバーサイドでどのように解析・検証され、利用されているかを追跡した。

## 結果

調査の結果、決済処理においては、フロントエンドからの入力値を信頼しない設計が適切に実装されていることが確認できた。

-   **認証**: すべての決済リクエストは、サーバーサイドで検証されるセッションCookieを要求しており、認証されていないユーザーによるリクエストは拒否される。
-   **入力値の検証**:
    *   フロントエンドから送信されるリクエストボディ（購入モード、プラン、バリエーション）は、`functions/api/checkout/session.ts` 内の `parseBody` 関数によって厳格に検証される。
    *   許可されていない値や、ビジネスロジック上ありえない組み合わせ（例：買い切りモードで年間プランを指定）は、エラーとして処理され、決済プロセスに進むことはない。
-   **価格決定ロジック**:
    *   決済金額を決定するStripeのPrice IDは、フロントエンドから直接指定されるのではなく、サーバーサイドの環境変数に設定された値が使用される。
    *   `parseBody` 関数での検証結果に基づき、安全に解決されたPrice IDのみがStripe APIに渡されるため、フロントエンド側で価格を不正に操作することはできない。
-   **数量の固定**: 購入数量はサーバーサイドで `1` にハードコードされており、フロントエンドから変更することはできない。
-   **API連携の安全性**: `stripeClient.ts` の `createCheckoutSession` メソッドに渡されるパラメータは、すべてサーバーサイドで検証または生成された値であり、フロントエンドからの入力がそのまま利用される箇所はなかった。

## 考察

現在の実装は、セキュリティのベストプラクティスに沿っており、フロントエンドからの入力に依存しない堅牢な設計となっている。特に、決済フローにおける価格決定ロジックがサーバーサイドに完全に移譲されている点は、高く評価できる。これにより、クライアントサイドでの不正な改ざんによるリスクを効果的に排除している。

## 推奨アクション

現状の実装でセキュリティ上の大きな問題は見当たらなかったため、**緊急の修正は不要**である。

ただし、今後の機能追加や仕様変更に際しても、以下の原則が維持されることを推奨する。

-   **入力値の再検証**: サーバーサイドで処理を行う際は、APIのエンドポイントで必ず入力値の型、フォーマット、範囲を再検証する。
-   **権限チェック**: リソースへのアクセスや操作を行う前には、その操作を実行する権限がユーザーに付与されているかを必ず確認する。
-   **ビジネスロジックのサーバーサイド集中**: 価格計算や割引適用など、重要なビジネスロジックは必ずサーバーサイドで実行する。

これらの原則を維持することで、将来的な開発においても、本プロジェクトの堅牢性を維持できると考えられる。
